<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>HTML → Figma (API)</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 16px;
      }
      label {
        font-size: 12px;
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
      }
      input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 8px;
        margin-bottom: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 12px;
      }
      textarea {
        width: 100%;
        height: 220px;
        box-sizing: border-box;
        margin-bottom: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 11px;
        font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        padding: 8px;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      button {
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
      }
      #fetch-url {
        background: #f3f3f3;
      }
      #convert {
        background: #18a0fb;
        color: white;
      }
      #status {
        font-size: 11px;
        margin-top: 4px;
        min-height: 14px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h3 style="margin-top: 0">HTML Page → Figma Auto Layout (API)</h3>
    <p style="font-size: 11px; color: #555; margin-top: 0">
      1) Digite uma URL e clique em <strong>Carregar URL</strong> ou cole o
      HTML manualmente.<br />
      2) Clique em <strong>Enviar para o Figma</strong>. O plugin manda o HTML
      para uma API externa que devolve o layout.
    </p>

    <label for="url-input">URL da página</label>
    <div class="row">
      <input
        id="url-input"
        type="text"
        placeholder="https://meusite.com"
        spellcheck="false"
      />
      <button id="fetch-url">Carregar URL</button>
    </div>

    <label for="html-input">HTML da página (editável)</label>
    <textarea
      id="html-input"
      placeholder="Cole aqui o HTML da página (ou carregue a partir da URL)..."
    ></textarea>

    <button id="convert">Enviar para o Figma</button>
    <div id="status"></div>

    <script>
      const urlInput = document.getElementById("url-input")
      const htmlInput = document.getElementById("html-input")
      const statusEl = document.getElementById("status")
      const fetchBtn = document.getElementById("fetch-url")
      const convertBtn = document.getElementById("convert")

      function setStatus(msg, isError = false) {
        statusEl.textContent = msg || ""
        statusEl.style.color = isError ? "#c00" : "#555"
      }

      // Carrega HTML direto da URL (no contexto da UI)
      fetchBtn.onclick = async () => {
        const url = (urlInput.value || "").trim()
        if (!url) {
          setStatus("Informe uma URL para carregar.", true)
          return
        }

        try {
          setStatus("Carregando HTML da URL...")
          const res = await fetch(url)
          if (!res.ok) throw new Error("Status HTTP: " + res.status)
          const html = await res.text()
          htmlInput.value = html
          setStatus("HTML carregado. Revise/ajuste se quiser e envie para o Figma.")
        } catch (err) {
          console.error(err)
          setStatus("Erro ao carregar a URL (CORS/bloqueio é comum).", true)
        }
      }

      // Envia HTML bruto + URL para o code.js
      convertBtn.onclick = () => {
        const html = (htmlInput.value || "").trim()
        const url = (urlInput.value || "").trim()

        if (!html) {
          setStatus("Cole ou carregue o HTML antes de enviar.", true)
          return
        }

        parent.postMessage(
          {
            pluginMessage: {
              type: "convert-via-api",
              html,
              url,
            },
          },
          "*"
        )

        setStatus("HTML enviado para o plugin. Aguarde o layout aparecer no canvas.")
      }
    </script>
  </body>
</html>